<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Photo Uploading and Cropping Tool (240x320)</title>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <!-- https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css-->
    <link rel="stylesheet" href="bootstrap.min.css">
    <!-- jQuery library -->
    <!-- https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js-->
    <script src="jquery.min.js"></script>
    <!-- Popper JS -->
    <!-- https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js-->
    <script src="popper.min.js"></script>
    <!-- Latest compiled JavaScript -->
    <!-- https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js-->
    <script src="bootstrap.min.js"></script>

    <!-- https://github.com/jaysalvat/jquery.facedetection JavaScript -->
    <script src="jquery.facedetection.min.js"></script>  

    <!-- camanjs -->
    <script src="caman.full.min.js"></script>  

    <style>
        canvas {
            width: 80%;
            height: auto;
        }
        
        @media only screen and (min-width: 500px) { 
            canvas {
                width: 400px;
                height: auto;
            }

            #gettingstarted {
                width: 500px;
                height: auto;
            }
        }


        #myCanvasTop { position: absolute; z-index: 2}
        #myCanvas    { position: absolute; z-index: 1}

        .fixed-bottom {
            position: fixed;
            margin: auto;
            height: 100px;
            width: 100%;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1030;
        }
    </style>
</head>

<body>

<div class="container-fluid">
    <div class="sticky-top">
        <button class="btn btn-info" id="btnRotate" disabled>Rotate photo</button>
        <button class="btn btn-info" id="btnFlip" disabled>Flip selfie</button>

        <button class="btn btn-primary" id="btnClearrect" disabled>Clear</button>
        <button class="btn btn-primary" id="btnReady" disabled>Ready</button>
        <button class="btn btn-primary" id="btnCrop" disabled>Crop</button>

        <div class="btn-group" role="group">
            <button class="btn btn-secondary movement" id="btnLeft" disabled>Left</button>
            <button class="btn btn-secondary movement" id="btnRight" disabled>Right</button>
        </div>
        <div class="btn-group" role="group">
            <button class="btn btn-secondary movement" id="btnUp" disabled>Up</button>
            <button class="btn btn-secondary movement" id="btnDown" disabled>Down</button>
        </div>
        <div class="btn-group" role="group">
            <button class="btn btn-secondary movement" id="btnBig" disabled>Bigger</button>
            <button class="btn btn-secondary movement" id="btnSmall" disabled>Smaller</button>
        </div>

        <div class="btn-group" role="group">
            <button class="btn btn-success filter" id="b_dec">-</button>
            <span class="filter" style="font-size:x-small">Brightness</span>
            <button class="btn btn-success filter" id="b_inc">+</button>
        </div>

        <div class="btn-group" role="group">
            <button class="btn btn-info filter" id="c_dec">-</button>
            <span class="filter" style="font-size:x-small">Contrast</span>
            <button class="btn btn-info filter" id="c_inc">+</button>
        </div>

        <div class="btn-group" role="group">
            <button class="btn btn-success filter" id="e_dec">-</button>
            <span class="filter" style="font-size:x-small">Exposure</span>
            <button class="btn btn-success filter" id="e_inc">+</button>
        </div>

        <div class="btn-group" role="group">
            <button class="btn btn-info filter" id="sa_dec">-</button>
            <span class="filter" style="font-size:x-small">Saturation</span>
            <button class="btn btn-info filter" id="sa_inc">+</button>
        </div>
        <button class="btn btn-primary" id="btnSave" disabled>Generate photo</button>
    </div>
    
    <p id="hints" class="mb-1 lead">ERROR: Your browser does not support this application.  Please try it with another browser.</p>
    <div class="input-group my-0">
        <input id="fileTocrop" type="file" class="form-control"  aria-describedby="basic-addon2">
    </div>

    <div class="input-group mb-1" id="fileInput">
        <input id="fileTosave" type="text" class="form-control" placeholder="NRIC Eg T1234567Z" aria-label="Name eg anything" aria-describedby="basic-addon2">
        <div class="input-group-append">
          <span id="labelTosave" class="input-group-text" id="basic-addon2">.jpg</span>
        </div>
    </div>

    <div id="samplepic">
        <img src="ez-link-student-photo.jpg" />
    </div>

    <div class="row" id="allCanvas">
        <div id="col2">
            <canvas  id="myCanvasTop"></canvas>
            <canvas  id="myCanvas"></canvas>
        </div>
        <div id="col3">
            <canvas  id="myCropcanvas"></canvas>
        </div>
        <div id="col4">
            <canvas  id="myTempcanvas"></canvas>
        </div>
    </div>



</div>

<!--Copyright (C) 2018 Puah Hock Leng - All Rights Reserved
    Puah_Hock_Leng&#64;ite&#46;edu&#46;sg  -->
    <script type="text/javascript">$(document).ready(function(){var t=320,e=240,a=30,o=$("#hints"),n=$("#alert1"),i=$("#alert2"),r=$("#fileTocrop"),s=$("#fileTosave"),c=$("#labelTosave"),h=$("#btnRotate"),d=$("#btnFlip"),l=$("#btnReady"),p=$("#btnAuto"),m=$("#btnClearrect"),u=$("#btnCrop"),g=$("#btnSave"),f=$("#btnLeft"),v=$("#btnRight"),b=$("#btnUp"),w=$("#btnDown"),C=$("#btnBig"),k=$("#btnSmall"),y=$(".movement"),_=$(".filter"),M=$("#b_inc"),x=$("#b_dec"),A=$("#c_inc"),R=$("#c_dec"),I=$("#e_inc"),S=$("#e_dec"),L=$("#sa_inc"),Y=$("#sa_dec"),D=($("#sh_inc"),$("#sh_dec"),$("#myCanvas")),T=D[0],X=T.getContext("2d"),P=$("#myCanvasTop")[0],j=P.getContext("2d");j.globalAlpha=.2;var O,U=$("#myCropcanvas")[0],B=U.getContext("2d"),F=$("#myTempcanvas")[0],z=F.getContext("2d"),E=($("#picture"),$("#col2")),G=$("#col3"),K=$("#col4"),J=$("#samplepic"),W=1,q=!1,H=/ipad|iphone|ipod/i.test(navigator.userAgent.toLowerCase()),N=/msie|trident|edge/i.test(navigator.userAgent.toLowerCase()),Q=/crios/i.test(navigator.userAgent.toLowerCase()),V=/webkit/i.test(navigator.userAgent.toLowerCase()),Z=Math.min(window.screen.width,window.screen.height)<768||navigator.userAgent.indexOf("Mobi")>-1,tt=["Rotate/Flip photo if necessary.  Click 'Ready' to start cropping","Click 'Automatic' to generate the rectangle","Click ‘Clear’ to redo.  Click ‘Crop’ if OK.  Click Left/ Right/ Up/ Down/ Bigger/ Smaller to adjust.","Type in the filename to save as and click ‘Generate photo’","Select a photo from your device to crop. (After cropping, your photo should look like the sample below)","Only Safari browser is supported on iPhones/iPads.  Your browser is not supported!","Only Chrome browser is supported on Desktop computers/Laptops.  Your browser is not supported!","Adjust Brightness, Contrast, Exposure and Saturation.  Then click 'Generate photo'"];H&&V&&Q?o.html("<div class='alert alert-danger' role='alert'>"+tt[5]+"</div>"):N?o.html("<div class='alert alert-danger' role='alert'>"+tt[6]+"</div>"):o.text(tt[4]),Z&&($(".sticky-top").addClass("text-center"),$("#samplepic").addClass("text-center"));var et,at;et=T.getBoundingClientRect(),at=window.devicePixelRatio,T.width=Math.round(at*et.right)-Math.round(at*et.left),T.height=Math.round(at*et.bottom)-Math.round(at*et.top),X.scale(at,at),s.hide(),c.hide(),D.hide(),h.hide(),d.hide(),l.hide(),p.hide(),m.hide(),u.hide(),g.hide(),y.hide(),_.hide();var ot,nt,it=new Image;r.on("change",function(a){o.text(tt[0]),n.hide(),i.hide(),J.hide();var s=new FileReader;s.onload=function(a){it.onload=function(){var a=2*e,o=2*t;ot=it.width,nt=it.height,ot>nt?ot>a&&(nt*=a/ot,ot=a):nt>o&&(ot*=o/nt,nt=o),P.width=T.width=ot,P.height=T.height=nt,X.drawImage(it,0,0,ot,nt),W=Math.round(5/a*ot)},it.src=a.target.result},s.readAsDataURL(a.target.files[0]),D.fadeIn(),E.addClass("col-12"),h.removeAttr("disabled").fadeIn(),d.removeAttr("disabled").fadeIn(),l.removeAttr("disabled").fadeIn(),r.hide(),!0,!0});var rt=1,st=!1;h.on("click",function(t){o.text(tt[0]),st=!0,ut(),rt++,st=!1,!0});var ct=1,ht=!1;d.on("click",function(t){o.text(tt[0]),ht=!0,ut(),ct++,ht=!1,!0});var dt,lt,pt,mt,ut=function(){X.clearRect(0,0,T.width,T.height);var t=st?rt:rt-1;t%2==0?(P.width=T.width=ot,P.height=T.height=nt):(P.width=T.width=nt,P.height=T.height=ot),X.save(),t%2==0?X.translate(ot/2,nt/2):X.translate(nt/2,ot/2),X.rotate(90*t*Math.PI/180),X.translate(-ot/2,-nt/2),(ht?ct:ct-1)%2==0||(t%2==0?(X.translate(ot,0),X.scale(-1,1)):(X.translate(0,nt),X.scale(1,-1))),X.drawImage(it,0,0,ot,nt),X.restore()},gt=!1;function ft(n){o.text(tt[2]),D.faceDetection({complete:function(o){if(console.log(o),1!=o.length)gt=!0;else{dt=o[0].x;var n=(lt=(o[0].offsetX+o[0].width)*o[0].scaleX)-dt;dt-=n/5,(lt+=n/5)>=ot&&(lt=ot-a),pt=o[0].y;var i=(mt=pt+t*(lt-dt)/e)-pt;mt-=i/4,_t(dt,pt-=i/4,!1),_t(lt,mt,!0),Mt(),xt()}},error:function(t,e){gt=!0}}),gt&&((mt=(pt=a)+t*((lt=ot-a)-(dt=a))/e)>=nt&&(lt=(dt=a)+e*((mt=nt-a)-(pt=a))/t),_t(dt,pt,!1),_t(lt,mt,!0),Mt(),xt()),console.log(dt,lt,pt,mt),!1,h.hide(),d.hide(),l.hide(),y.removeAttr("disabled"),y.show()}l.on("click",ft),p.on("click",ft),f.on("click",function(t){lt-=5,(dt-=5)<=0&&(X_temp=dt,dt=1,lt=lt+1-X_temp),_t(dt,pt,!1),_t(lt,mt,!0),Mt(),xt(),q=!1}),v.on("click",function(t){dt+=5,(lt+=5)>=ot&&(X_temp=lt,lt=ot-1,dt=dt-(X_temp-ot)-1),_t(dt,pt,!1),_t(lt,mt,!0),Mt(),xt(),q=!1}),b.on("click",function(t){mt-=5,(pt-=5)<=0&&(Y_temp=pt,pt=1,mt=mt+1-Y_temp),_t(dt,pt,!1),_t(lt,mt,!0),Mt(),xt(),q=!1}),w.on("click",function(t){pt+=5,(mt+=5)>=nt&&(Y_temp=mt,mt=nt-1,pt=pt-(Y_temp-nt)-1),_t(dt,pt,!1),_t(lt,mt,!0),Mt(),xt(),q=!1}),C.on("click",function(a){q||(mt=pt+t*((lt+=5)-dt)/e,lt>=ot&&(X_temp=lt,lt=ot-1,dt=dt-(X_temp-ot)-1,q=!0),dt<=0&&(X_temp=dt,dt=1,lt=lt+1-X_temp),mt>=nt&&(Y_temp=mt,mt=nt-1,pt=pt-(Y_temp-nt)-1,q=!0),pt<=0&&(Y_temp=pt,pt=1,mt=mt+1-Y_temp),_t(dt,pt,!1),_t(lt,mt,!0),Mt(),xt())}),k.on("click",function(a){mt=pt+t*((lt-=5)-dt)/e,_t(dt,pt,!1),_t(lt,mt,!0),Mt(),xt(),q=!1}),m.on("click",function(t){o.text(tt[1]),xt(),j.clearRect(0,0,T.width,T.height),!0,u.hide(),y.hide(),_.hide(),l.removeAttr("disabled").fadeIn(),q=!1}),u.on("click",function(){if(o.text(tt[7]),m.hide(),u.hide(),p.hide(),g.removeAttr("disabled").fadeIn(),y.hide(),_.removeAttr("disabled"),_.show(),Ct>kt){var a=Ct;Ct=kt,kt=a}if($t>yt){a=$t;$t=yt,yt=a}O=X.getImageData(Ct,$t,kt-Ct,yt-$t),F.width=kt-Ct,F.height=yt-$t,z.putImageData(O,0,0),U.width=e,U.height=t;var n=new Image;n.onload=function(){B.drawImage(n,0,0,e,t)},n.src=F.toDataURL(),E.remove(),G.addClass("col-6"),K.remove(),!0});M.on("click",function(){Caman("#myCropcanvas",function(){this.brightness(4),this.render()})}),x.on("click",function(){Caman("#myCropcanvas",function(){this.brightness(-4),this.render()})}),A.on("click",function(){Caman("#myCropcanvas",function(){this.contrast(4),this.render()})}),R.on("click",function(){Caman("#myCropcanvas",function(){this.contrast(-4),this.render()})}),I.on("click",function(){Caman("#myCropcanvas",function(){this.exposure(4),this.render()})}),S.on("click",function(){Caman("#myCropcanvas",function(){this.exposure(-4),this.render()})}),L.on("click",function(){Caman("#myCropcanvas",function(){this.saturation(4),this.render()})}),Y.on("click",function(){Caman("#myCropcanvas",function(){this.saturation(-4),this.render()})}),g.on("click",function(){var t="<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>Photo Uploading and Cropping Tool</title><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css'><script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js'><\/script></head><body><div class='container-fluid'><p class='mb-1'><div class='alert alert-danger' role='alert'>Step 1: Check: Compare the size of your head in your cropped photo to the sample image on the right/bottom.  <a href='./index.html'>Recrop</a> if it's too small!!! Step 2: If OK, save the photo: Tap and hold/right-click on your cropped photo. Select Save Image to save.  Step 3: Login and upload via <a href='https://myportal.ite.edu.sg/photo'>myportal.ite.edu.sg/photo</a>.</div></p><div class='text-center'><img src='"+U.toDataURL("image/jpeg",1)+"' alt='from canvas'/><img src='ez-link-student-photo.jpg' width='"+e+"'/></div></div></body></html>",a=window.open();a.document.write(t),a?a.focus():alert("Please allow popups for this website")});var vt=new Array,bt=new Array,wt=new Array,Ct=0,$t=0,kt=0,yt=0,_t=function(t,e,a){vt.push(t),bt.push(e),wt.push(a)},Mt=function(){j.strokeStyle="#df4b26",j.lineJoin="butt",j.lineWidth=W,vt.length>0&&(j.clearRect(0,0,T.width,T.height),Ct=vt[0],$t=bt[0],kt=vt[vt.length-1],yt=bt[bt.length-1],Ct<kt&&$t<yt?(Math.abs(kt-Ct)/Math.abs(yt-$t)<e/t?yt=t/e*(kt-Ct)+$t:kt=e/t*(yt-$t)+Ct,j.strokeRect(Ct,$t,Math.abs(kt-Ct),Math.abs(yt-$t))):Ct>kt&&$t<yt?(Math.abs(kt-Ct)/Math.abs(yt-$t)<e/t?yt=t/e*(Ct-kt)+$t:kt=Ct-e/t*(yt-$t),j.strokeRect(kt,$t,Math.abs(kt-Ct),Math.abs(yt-$t))):Ct<kt&&$t>yt?(Math.abs(kt-Ct)/Math.abs(yt-$t)<e/t?yt=t/e*(kt-Ct)+$t:kt=e/t*($t-yt)+Ct,j.strokeRect(Ct,yt,Math.abs(kt-Ct),Math.abs(yt-$t))):(Math.abs(kt-Ct)/Math.abs(yt-$t)<e/t?yt=t/e*(Ct-kt)+$t:kt=Ct-e/t*($t-yt),j.strokeRect(kt,yt,Math.abs(kt-Ct),Math.abs(yt-$t))),m.removeAttr("disabled").fadeIn(),u.removeAttr("disabled").fadeIn(),h.hide(),d.hide())},xt=function(){vt.length=0,bt.length=0,wt.length=0,!1}});</script>
    </body>
</html>