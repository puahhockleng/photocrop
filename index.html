<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Photo Uploading and Cropping Tool</title>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <!-- https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css-->
    <link rel="stylesheet" href="bootstrap.min.css">
    <!-- jQuery library -->
    <!-- https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js-->
    <script src="jquery.min.js"></script>
    <!-- Popper JS -->
    <!-- https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js-->
    <script src="popper.min.js"></script>
    <!-- Latest compiled JavaScript -->
    <!-- https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js-->
    <script src="bootstrap.min.js"></script>

    <!-- https://github.com/jaysalvat/jquery.facedetection JavaScript -->
    <script src="jquery.facedetection.min.js"></script>  

    <!-- camanjs -->
    <script src="caman.full.min.js"></script>  

    <style>
        canvas {
            width: 80%;
            height: auto;
        }
        
        @media only screen and (min-width: 500px) { 
            canvas {
                width: 400px;
                height: auto;
            }

            #gettingstarted {
                width: 500px;
                height: auto;
            }
        }


        #myCanvasTop { position: absolute; z-index: 2}
        #myCanvas    { position: absolute; z-index: 1}

        .fixed-bottom {
            position: fixed;
            margin: auto;
            height: 100px;
            width: 100%;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1030;
        }
    </style>
</head>

<body>

<div class="container-fluid">
    <div class="sticky-top">
        <button class="btn btn-primary" id="btnRotate" disabled>Rotate photo</button>
        <button class="btn btn-primary" id="btnFlip" disabled>Flip selfie</button>

        <button class="btn btn-primary" id="btnClearrect" disabled>Clear</button>
        <button class="btn btn-primary" id="btnReady" disabled>Ready</button>
        <button class="btn btn-primary" id="btnCrop" disabled>Crop</button>

        <button class="btn btn-secondary movement" id="btnLeft" disabled>Left</button>
        <button class="btn btn-secondary movement" id="btnRight" disabled>Right</button>
        <button class="btn btn-secondary movement" id="btnUp" disabled>Up</button>
        <button class="btn btn-secondary movement" id="btnDown" disabled>Down</button>
        <button class="btn btn-secondary movement" id="btnBig" disabled>Bigger</button>
        <button class="btn btn-secondary movement" id="btnSmall" disabled>Smaller</button>

        <button class="btn btn-success filter" id="b_dec">-</button>
        <span class="filter">Brightness</span>
        <button class="btn btn-success filter" id="b_inc">+</button>

        <button class="btn btn-info filter" id="c_dec">-</button>
        <span class="filter">Contrast</span>
        <button class="btn btn-info filter" id="c_inc">+</button>

        <button class="btn btn-success filter" id="e_dec">-</button>
        <span class="filter">Exposure</span>
        <button class="btn btn-success filter" id="e_inc">+</button>

        <button class="btn btn-info filter" id="sa_dec">-</button>
        <span class="filter">Saturation</span>
        <button class="btn btn-info filter" id="sa_inc">+</button>

        <button class="btn btn-primary" id="btnSave" disabled>Generate photo</button>
    </div>
    
    <p id="hints" class="mb-1 lead">ERROR: Your browser does not support this application.  Please try it with another browser.</p>
    <div class="input-group my-0">
        <input id="fileTocrop" type="file" class="form-control"  aria-describedby="basic-addon2">
    </div>

    <div class="input-group mb-1" id="fileInput">
        <input id="fileTosave" type="text" class="form-control" placeholder="NRIC Eg T1234567Z" aria-label="Name eg anything" aria-describedby="basic-addon2">
        <div class="input-group-append">
          <span id="labelTosave" class="input-group-text" id="basic-addon2">.jpg</span>
        </div>
    </div>

    <div id="samplepic">
        <img src="ez-link-student-photo.jpg" />
    </div>

    <div class="row" id="allCanvas">
        <div id="col2">
            <canvas  id="myCanvasTop"></canvas>
            <canvas  id="myCanvas"></canvas>
        </div>
        <div id="col3">
            <canvas  id="myCropcanvas"></canvas>
        </div>
        <div id="col4">
            <canvas  id="myTempcanvas"></canvas>
        </div>
    </div>



</div>

<!--Copyright (C) 2018 Puah Hock Leng - All Rights Reserved
    Puah_Hock_Leng&#64;ite&#46;edu&#46;sg  -->
    <script type="text/javascript">$(document).ready(function(){var t=320,e=240,a=30,n=$("#hints"),o=$("#alert1"),i=$("#alert2"),r=$("#fileTocrop"),s=$("#fileTosave"),c=$("#labelTosave"),h=$("#btnRotate"),d=$("#btnFlip"),l=$("#btnReady"),p=$("#btnAuto"),m=$("#btnClearrect"),u=$("#btnCrop"),g=$("#btnSave"),f=$("#btnLeft"),v=$("#btnRight"),b=$("#btnUp"),w=$("#btnDown"),C=$("#btnBig"),k=$("#btnSmall"),y=$(".movement"),_=$(".filter"),A=$("#b_inc"),M=$("#b_dec"),x=$("#c_inc"),R=$("#c_dec"),I=$("#e_inc"),S=$("#e_dec"),L=$("#sa_inc"),Y=$("#sa_dec"),D=($("#sh_inc"),$("#sh_dec"),$("#myCanvas")),T=D[0],X=T.getContext("2d"),P=$("#myCanvasTop")[0],U=P.getContext("2d");U.globalAlpha=.2;var j,B=$("#myCropcanvas")[0],O=B.getContext("2d"),F=$("#myTempcanvas")[0],E=F.getContext("2d"),G=($("#picture"),$("#col2")),J=$("#col3"),K=$("#col4"),W=$("#samplepic"),q=1,z=!1,H=/ipad|iphone|ipod/i.test(navigator.userAgent.toLowerCase()),N=/msie|trident|edge/i.test(navigator.userAgent.toLowerCase()),Q=/crios/i.test(navigator.userAgent.toLowerCase()),V=/webkit/i.test(navigator.userAgent.toLowerCase()),Z=["Rotate/Flip photo if necessary.  Click 'Ready' to start cropping","Click 'Automatic' to generate the rectangle","Click ‘Clear’ to redo.  Click ‘Crop’ if OK.  Click Left/ Right/ Up/ Down/ Bigger/ Smaller to adjust.","Type in the filename to save as and click ‘Generate photo’","Select a photo from your device to crop. (After cropping, your photo should look like the sample below)","Only Safari browser is supported on iPhones/iPads.  Your browser is not supported!","Only Chrome browser is supported on Desktop computers/Laptops.  Your browser is not supported!","Adjust Brightness, Contrast, Exposure and Saturation.  Then click 'Generate photo'"];H&&V&&Q?n.html("<div class='alert alert-danger' role='alert'>"+Z[5]+"</div>"):N?n.html("<div class='alert alert-danger' role='alert'>"+Z[6]+"</div>"):n.text(Z[4]);var tt,et;tt=T.getBoundingClientRect(),et=window.devicePixelRatio,T.width=Math.round(et*tt.right)-Math.round(et*tt.left),T.height=Math.round(et*tt.bottom)-Math.round(et*tt.top),X.scale(et,et),s.hide(),c.hide(),D.hide(),h.hide(),d.hide(),l.hide(),p.hide(),m.hide(),u.hide(),g.hide(),y.hide(),_.hide();var at,nt,ot=new Image;r.on("change",function(a){n.text(Z[0]),o.hide(),i.hide(),W.hide();var s=new FileReader;s.onload=function(a){ot.onload=function(){var a=2*e,n=2*t;at=ot.width,nt=ot.height,at>nt?at>a&&(nt*=a/at,at=a):nt>n&&(at*=n/nt,nt=n),P.width=T.width=at,P.height=T.height=nt,X.drawImage(ot,0,0,at,nt),q=Math.round(5/a*at)},ot.src=a.target.result},s.readAsDataURL(a.target.files[0]),D.fadeIn(),G.addClass("col-12"),h.removeAttr("disabled").fadeIn(),d.removeAttr("disabled").fadeIn(),l.removeAttr("disabled").fadeIn(),r.hide(),!0,!0});var it=1,rt=!1;h.on("click",function(t){n.text(Z[0]),rt=!0,mt(),it++,rt=!1,!0});var st=1,ct=!1;d.on("click",function(t){n.text(Z[0]),ct=!0,mt(),st++,ct=!1,!0});var ht,dt,lt,pt,mt=function(){X.clearRect(0,0,T.width,T.height);var t=rt?it:it-1;t%2==0?(P.width=T.width=at,P.height=T.height=nt):(P.width=T.width=nt,P.height=T.height=at),X.save(),t%2==0?X.translate(at/2,nt/2):X.translate(nt/2,at/2),X.rotate(90*t*Math.PI/180),X.translate(-at/2,-nt/2),(ct?st:st-1)%2==0||(t%2==0?(X.translate(at,0),X.scale(-1,1)):(X.translate(0,nt),X.scale(1,-1))),X.drawImage(ot,0,0,at,nt),X.restore()},ut=!1;function gt(o){n.text(Z[2]),D.faceDetection({complete:function(n){if(console.log(n),1!=n.length)ut=!0;else{ht=n[0].x;var o=(dt=(n[0].offsetX+n[0].width)*n[0].scaleX)-ht;ht-=o/5,(dt+=o/5)>=e&&(dt=e-a),lt=n[0].y;var i=(pt=lt+t*(dt-ht)/e)-lt;pt-=i/4,yt(ht,lt-=i/4,!1),yt(dt,pt,!0),_t(),At()}},error:function(t,e){ut=!0}}),ut&&((pt=(lt=a)+t*((dt=e-a)-(ht=a))/e)>=t&&(dt=(ht=a)+e*((pt=t-a)-(lt=a))/t),yt(ht,lt,!1),yt(dt,pt,!0),_t(),At()),console.log(ht,dt,lt,pt),!1,h.hide(),d.hide(),l.hide(),y.removeAttr("disabled"),y.show()}l.on("click",gt),p.on("click",gt),f.on("click",function(t){dt-=5,(ht-=5)<=0&&(X_temp=ht,ht=1,dt=dt+1-X_temp),yt(ht,lt,!1),yt(dt,pt,!0),_t(),At(),z=!1}),v.on("click",function(t){ht+=5,(dt+=5)>=at&&(X_temp=dt,dt=at-1,ht=ht-(X_temp-at)-1),yt(ht,lt,!1),yt(dt,pt,!0),_t(),At(),z=!1}),b.on("click",function(t){pt-=5,(lt-=5)<=0&&(Y_temp=lt,lt=1,pt=pt+1-Y_temp),yt(ht,lt,!1),yt(dt,pt,!0),_t(),At(),z=!1}),w.on("click",function(t){lt+=5,(pt+=5)>=nt&&(Y_temp=pt,pt=nt-1,lt=lt-(Y_temp-nt)-1),yt(ht,lt,!1),yt(dt,pt,!0),_t(),At(),z=!1}),C.on("click",function(a){z||(pt=lt+t*((dt+=5)-ht)/e,dt>=at&&(X_temp=dt,dt=at-1,ht=ht-(X_temp-at)-1,z=!0),ht<=0&&(X_temp=ht,ht=1,dt=dt+1-X_temp),pt>=nt&&(Y_temp=pt,pt=nt-1,lt=lt-(Y_temp-nt)-1,z=!0),lt<=0&&(Y_temp=lt,lt=1,pt=pt+1-Y_temp),yt(ht,lt,!1),yt(dt,pt,!0),_t(),At())}),k.on("click",function(a){pt=lt+t*((dt-=5)-ht)/e,yt(ht,lt,!1),yt(dt,pt,!0),_t(),At(),z=!1}),m.on("click",function(t){n.text(Z[1]),At(),U.clearRect(0,0,T.width,T.height),!0,u.hide(),y.hide(),_.hide(),l.removeAttr("disabled").fadeIn(),z=!1}),u.on("click",function(){if(n.text(Z[7]),m.hide(),u.hide(),p.hide(),g.removeAttr("disabled").fadeIn(),y.hide(),_.removeAttr("disabled"),_.show(),wt>$t){var a=wt;wt=$t,$t=a}if(Ct>kt){a=Ct;Ct=kt,kt=a}j=X.getImageData(wt,Ct,$t-wt,kt-Ct),F.width=$t-wt,F.height=kt-Ct,E.putImageData(j,0,0),B.width=e,B.height=t;var o=new Image;o.onload=function(){O.drawImage(o,0,0,e,t)},o.src=F.toDataURL(),G.remove(),J.addClass("col-6"),K.remove(),!0});A.on("click",function(){Caman("#myCropcanvas",function(){this.brightness(4),this.render()})}),M.on("click",function(){Caman("#myCropcanvas",function(){this.brightness(-4),this.render()})}),x.on("click",function(){Caman("#myCropcanvas",function(){this.contrast(4),this.render()})}),R.on("click",function(){Caman("#myCropcanvas",function(){this.contrast(-4),this.render()})}),I.on("click",function(){Caman("#myCropcanvas",function(){this.exposure(4),this.render()})}),S.on("click",function(){Caman("#myCropcanvas",function(){this.exposure(-4),this.render()})}),L.on("click",function(){Caman("#myCropcanvas",function(){this.saturation(4),this.render()})}),Y.on("click",function(){Caman("#myCropcanvas",function(){this.saturation(-4),this.render()})}),g.on("click",function(){var t="<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>Photo Uploading and Cropping Tool</title><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css'><script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js'><\/script></head><body><div class='container-fluid'><p class='mb-1'><div class='alert alert-danger' role='alert'>Step 1: Save the photo: Tap and hold/right-click on the image. Select the Save Image button to save.  Step 2: Login and upload via <a href='https://myportal.ite.edu.sg/photo'>myportal.ite.edu.sg/photo</a>.</div></p><div class='text-center'><img src='"+B.toDataURL("image/jpeg",1)+"' alt='from canvas'/></div></div></body></html>",e=window.open();e.document.write(t),e?e.focus():alert("Please allow popups for this website")});var ft=new Array,vt=new Array,bt=new Array,wt=0,Ct=0,$t=0,kt=0,yt=function(t,e,a){ft.push(t),vt.push(e),bt.push(a)},_t=function(){U.strokeStyle="#df4b26",U.lineJoin="butt",U.lineWidth=q,ft.length>0&&(U.clearRect(0,0,T.width,T.height),wt=ft[0],Ct=vt[0],$t=ft[ft.length-1],kt=vt[vt.length-1],wt<$t&&Ct<kt?(Math.abs($t-wt)/Math.abs(kt-Ct)<e/t?kt=t/e*($t-wt)+Ct:$t=e/t*(kt-Ct)+wt,U.strokeRect(wt,Ct,Math.abs($t-wt),Math.abs(kt-Ct))):wt>$t&&Ct<kt?(Math.abs($t-wt)/Math.abs(kt-Ct)<e/t?kt=t/e*(wt-$t)+Ct:$t=wt-e/t*(kt-Ct),U.strokeRect($t,Ct,Math.abs($t-wt),Math.abs(kt-Ct))):wt<$t&&Ct>kt?(Math.abs($t-wt)/Math.abs(kt-Ct)<e/t?kt=t/e*($t-wt)+Ct:$t=e/t*(Ct-kt)+wt,U.strokeRect(wt,kt,Math.abs($t-wt),Math.abs(kt-Ct))):(Math.abs($t-wt)/Math.abs(kt-Ct)<e/t?kt=t/e*(wt-$t)+Ct:$t=wt-e/t*(Ct-kt),U.strokeRect($t,kt,Math.abs($t-wt),Math.abs(kt-Ct))),m.removeAttr("disabled").fadeIn(),u.removeAttr("disabled").fadeIn(),h.hide(),d.hide())},At=function(){ft.length=0,vt.length=0,bt.length=0,!1}});</script>
    </body>
</html>